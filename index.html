<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ö–æ–ª—Å—Ç</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            background: #f0f0f0;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            width: 2560px;
            height: 1212px;
            position: relative;
        }
        #controls {
            background: #f0f0f0;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            height: 60px;
            box-sizing: border-box;
            z-index: 100;
            position: relative;
        }
        #thumbnails-container {
            display: flex;
            align-items: center;
            overflow-x: auto;
            margin-left: 20px;
            height: 60px;
            background: #e0e0e0;
            border-radius: 4px;
            padding: 0 10px;
            flex-grow: 1;
        }
        #thumbnails {
            display: flex;
            gap: 10px;
        }
        .thumbnail {
            position: relative;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .text-thumbnail {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
            text-align: center;
            width: 100%;
            height: 100%;
        }
        .sound-thumbnail {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e0f0ff;
            border-radius: 3px;
            font-size: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
            text-align: center;
            width: 100%;
            height: 100%;
        }
        .thumbnail.selected {
            border-color: #4285f4;
        }
        .thumbnail.selected .text-thumbnail {
            background: #e0e0e0;
        }
        .thumbnail.selected .sound-thumbnail {
            background: #c0e0ff;
        }
        .thumbnail-hidden {
            opacity: 0.5;
        }
        .thumbnail-button {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            border: none;
            border-radius: 50%;
            background: #f44336;
            color: white;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thumbnail-button.show {
            background: #4caf50;
        }
        #image-controls {
            display: flex;
            gap: 10px;
            margin-left: 20px;
            display: none;
        }
        #text-controls {
            display: flex;
            gap: 10px;
            margin-left: 20px;
            display: none;
        }
        #sound-controls {
            display: flex;
            gap: 10px;
            margin-left: 20px;
            display: none;
            align-items: center;
        }
       
        #canvas-wrapper {
            width: 2560px;
            height: 1152px;
            position: relative;
            overflow: hidden;
            background-color: transparent;
        }
       
        #images-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
            background: transparent !important;
        }
       
        #texts-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
            background: transparent !important;
        }
       
        .draggable-image {
            position: absolute;
            cursor: move;
            user-select: none;
            touch-action: none;
            transition: opacity 0.3s, filter 0.3s;
            opacity: 1;
            box-sizing: border-box;
            filter: brightness(100%);
            pointer-events: auto;
            background-color: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            transform-origin: center center;
        }
        .draggable-image img {
            width: 100%;
            height: 100%;
            object-fit: fill;
            pointer-events: none;
            display: block;
            background-color: transparent !important;
        }
        .draggable-text {
            position: absolute;
            cursor: move;
            user-select: none;
            touch-action: none;
            box-sizing: content-box;
            opacity: 1;
            display: inline-block;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            transform-origin: top left;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 5px 8px;
            border-radius: 3px;
            pointer-events: auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
            min-width: 20px;
            min-height: 20px;
            line-height: 1.3;
        }
        .selected {
            position: relative;
            box-shadow: 0 0 0 2px #4285f4 inset;
        }
        .locked {
            box-shadow: 0 0 0 2px #ff0000 inset !important;
        }
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #4285f4;
            border: 1px solid white;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .resize-n {
            top: -5px;
            left: 50%;
            margin-left: -5px;
            cursor: n-resize;
        }
        .resize-ne {
            top: -5px;
            right: -5px;
            cursor: ne-resize;
        }
        .resize-e {
            top: 50%;
            right: -5px;
            margin-top: -5px;
            cursor: e-resize;
        }
        .resize-se {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }
        .resize-s {
            bottom: -5px;
            left: 50%;
            margin-left: -5px;
            cursor: s-resize;
        }
        .resize-sw {
            bottom: -5px;
            left: -5px;
            cursor: sw-resize;
        }
        .resize-w {
            top: 50%;
            left: -5px;
            margin-top: -5px;
            cursor: w-resize;
        }
        .resize-nw {
            top: -5px;
            left: -5px;
            cursor: nw-resize;
        }
        .rotate-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #34a853;
            border: 2px solid white;
            border-radius: 50%;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
            top: -25px;
            left: 50%;
            margin-left: -8px;
            cursor: grab;
        }
        .selected:not(.locked) .resize-handle,
        .selected:not(.locked) .rotate-handle {
            opacity: 1;
        }
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: #4285f4;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        #file-input {
            display: none;
        }
        #sound-input {
            display: none;
        }
        #status {
            margin-left: 10px;
            font-size: 14px;
            color: #666;
            white-space: nowrap;
        }
        .properties-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
        }
        .properties-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .properties-panel label {
            display: block;
            margin-bottom: 5px;
        }
        .properties-panel input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .transform-panel {
            position: absolute;
            top: 120px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
            width: 250px;
        }
        .transform-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        .transform-control {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
        }
        .transform-control label {
            min-width: 100px;
            font-size: 14px;
        }
        .transform-control input[type="range"] {
            flex: 1;
        }
        .transform-value {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
        }
        .transform-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .transform-buttons button {
            flex: 1;
        }
        #flip-horizontal-btn {
            background: #fbbc05;
        }
        #flip-vertical-btn {
            background: #ea4335;
        }
        #reset-transform-btn {
            background: #666;
        }
        
        /* –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
        #simple-text-input {
            position: absolute;
            z-index: 1000;
            background: white;
            border: 2px solid #4285f4;
            border-radius: 5px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            min-width: 200px;
        }
        #simple-text-input textarea {
            width: 300px;
            min-height: 60px;
            padding: 10px;
            border: none;
            border-radius: 3px;
            resize: both;
            font-family: Arial, sans-serif;
            font-size: 16px;
            box-sizing: border-box;
            overflow-y: auto;
            outline: none;
            line-height: 1.3;
        }
        .text-toolbar {
            display: flex;
            gap: 5px;
            padding: 5px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            flex-wrap: wrap;
        }
        .text-toolbar button {
            padding: 5px 10px;
            font-size: 12px;
        }
        .text-toolbar select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
        .text-toolbar input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            background: none;
            cursor: pointer;
        }
        .text-toolbar input[type="range"] {
            width: 60px;
        }
        
        .sound-visualization {
            width: 100px;
            height: 30px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .sound-progress {
            height: 100%;
            background: #4285f4;
            width: 0%;
            transition: width 0.1s;
        }
        #audio-element {
            display: none;
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .volume-slider {
            width: 80px;
        }
        #tts-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
            width: 300px;
        }
        #tts-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        #tts-text-input {
            width: 100%;
            height: 80px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
        }
        .tts-controls-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .tts-voice-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tts-control-label {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            min-width: 60px;
        }
        .tts-slider {
            flex: 1;
        }
        .tts-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .tts-buttons button {
            flex: 1;
        }
        #tts-play-btn {
            background: #4caf50;
        }
        #tts-pause-btn {
            background: #ff9800;
        }
        #tts-stop-btn {
            background: #f44336;
        }
        
        .rotation-indicator {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .dragging .rotation-indicator {
            opacity: 1;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è URL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .modal input[type="url"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="controls">
            <button onclick="document.getElementById('file-input').click()">–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
            <button id="add-text-btn">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            <button id="add-sound-btn">–î–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫</button>
            <button id="speak-text-btn">–û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            <button id="load-from-url-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ URL</button>
            <button id="transform-btn">–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è</button>
            <button id="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
           
            <div id="thumbnails-container">
                <div id="thumbnails"></div>
            </div>
           
            <div id="image-controls">
                <button id="hide-btn">–°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å</button>
                <button id="delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                <button id="settings-btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button id="lock-btn">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
            </div>
           
            <div id="text-controls">
                <button id="hide-text-btn">–°–∫—Ä—ã—Ç—å/–ü–æ–∫–∞–∑–∞—Ç—å</button>
                <button id="edit-text-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button id="delete-text-btn">–£–¥–∞–ª–∏—Ç—å</button>
                <button id="lock-text-btn">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
            </div>
           
            <div id="sound-controls">
                <button id="play-btn">‚ñ∂</button>
                <button id="pause-btn">‚è∏</button>
                <div class="sound-visualization">
                    <div class="sound-progress" id="sound-progress"></div>
                </div>
                <div class="volume-control">
                    <span>üîä</span>
                    <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100">
                </div>
                <button id="delete-sound-btn">–£–¥–∞–ª–∏—Ç—å –∑–≤—É–∫</button>
            </div>
           
            <div id="status">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>
       
        <div id="canvas-wrapper">
            <div id="images-layer"></div>
            <div id="texts-layer"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ URL -->
    <div id="url-modal" class="modal-overlay">
        <div class="modal">
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ URL</h3>
            <input type="url" id="url-input" placeholder="https://lowka227.github.io/sd/example.png" value="https://lowka227.github.io/sd/">
            <div class="modal-buttons">
                <button id="cancel-url">–û—Ç–º–µ–Ω–∞</button>
                <button id="load-url" style="background: #4285f4;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ -->
    <div id="simple-text-input">
        <textarea id="text-input-area" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
        <div class="text-toolbar">
            <select id="font-family-select">
                <option value="'Comic Sans MS', cursive">Comic Sans</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="Verdana, sans-serif">Verdana</option>
            </select>
            <input type="range" id="font-size-slider" min="12" max="72" value="16" title="–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞">
            <input type="color" id="text-color-picker" value="#000000" title="–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞">
            <button id="apply-text-simple">–ì–æ—Ç–æ–≤–æ</button>
            <button id="cancel-text-simple" style="background: #f44336;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
   
    <div class="properties-panel" id="properties-panel">
        <h3>–°–≤–æ–π—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
        <label>
            –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:
            <input type="range" id="opacity-slider" min="0" max="100" value="100">
        </label>
        <label>
            –Ø—Ä–∫–æ—Å—Ç—å:
            <input type="range" id="brightness-slider" min="0" max="200" value="100">
        </label>
        <button id="close-properties">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div class="transform-panel" id="transform-panel">
        <h3>–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
        
        <div class="transform-control">
            <label>–ü–æ–≤–æ—Ä–æ—Ç:</label>
            <input type="range" id="rotation-slider" min="0" max="360" value="0">
            <span class="transform-value" id="rotation-value">0¬∞</span>
        </div>
        
        <div class="transform-control">
            <label>–ú–∞—Å—à—Ç–∞–± X:</label>
            <input type="range" id="scale-x-slider" min="10" max="300" value="100">
            <span class="transform-value" id="scale-x-value">100%</span>
        </div>
        
        <div class="transform-control">
            <label>–ú–∞—Å—à—Ç–∞–± Y:</label>
            <input type="range" id="scale-y-slider" min="10" max="300" value="100">
            <span class="transform-value" id="scale-y-value">100%</span>
        </div>
        
        <div class="transform-control">
            <label>–ò—Å–∫–∞–∂–µ–Ω–∏–µ X:</label>
            <input type="range" id="skew-x-slider" min="-50" max="50" value="0">
            <span class="transform-value" id="skew-x-value">0¬∞</span>
        </div>
        
        <div class="transform-control">
            <label>–ò—Å–∫–∞–∂–µ–Ω–∏–µ Y:</label>
            <input type="range" id="skew-y-slider" min="-50" max="50" value="0">
            <span class="transform-value" id="skew-y-value">0¬∞</span>
        </div>
        
        <div class="transform-buttons">
            <button id="flip-horizontal-btn">–û—Ç—Ä–∞–∑–∏—Ç—å –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏</button>
            <button id="flip-vertical-btn">–û—Ç—Ä–∞–∑–∏—Ç—å –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏</button>
            <button id="reset-transform-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        
        <button id="close-transform" style="margin-top: 10px; width: 100%; background: #666;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
   
    <div id="tts-panel">
        <h3>–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</h3>
        <textarea id="tts-text-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è..."></textarea>
       
        <div class="tts-controls-row">
            <select id="tts-voice-select" class="tts-voice-select">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å...</option>
            </select>
        </div>
       
        <div class="tts-controls-row">
            <span class="tts-control-label">–°–∫–æ—Ä–æ—Å—Ç—å:</span>
            <input type="range" class="tts-slider" id="tts-rate-slider" min="0.5" max="2" step="0.1" value="1">
            <span class="tts-control-label" id="tts-rate-value">1.0</span>
        </div>
       
        <div class="tts-controls-row">
            <span class="tts-control-label">–í—ã—Å–æ—Ç–∞:</span>
            <input type="range" class="tts-slider" id="tts-pitch-slider" min="0.5" max="2" step="0.1" value="1">
            <span class="tts-control-label" id="tts-pitch-value">1.0</span>
        </div>
       
        <div class="tts-controls-row">
            <span class="tts-control-label">–ì—Ä–æ–º–∫–æ—Å—Ç—å:</span>
            <input type="range" class="tts-slider" id="tts-volume-slider" min="0" max="1" step="0.1" value="1">
            <span class="tts-control-label" id="tts-volume-value">1.0</span>
        </div>
       
        <div class="tts-buttons">
            <button id="tts-play-btn">‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
            <button id="tts-pause-btn">‚è∏ –ü–∞—É–∑–∞</button>
            <button id="tts-stop-btn">‚ñ† –°—Ç–æ–ø</button>
        </div>
       
        <button id="tts-close-btn" style="margin-top: 10px; width: 100%; background: #666;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
   
    <input type="file" id="file-input" accept="image/*">
    <input type="file" id="sound-input" accept="audio/*">
   
    <audio id="audio-element"></audio>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
   
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDNWDm3Rkvq4mV7Cvf5ckvZvDD5MNLDXoo",
            authDomain: "greenbackgroundapp.firebaseapp.com",
            databaseURL: "https://greenbackgroundapp-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "greenbackgroundapp",
            storageBucket: "greenbackgroundapp.appspot.com",
            messagingSenderId: "857271333291",
            appId: "1:857271333291:web:e754824268f37341c7e2ee",
            measurementId: "G-S5HL7Q45NE"
        };
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.log("Firebase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        }
       
        const database = firebase.database();
        const imagesRef = database.ref('images');
        const textsRef = database.ref('texts');
        const soundsRef = database.ref('sounds');
       
        let images = {};
        let texts = {};
        let sounds = {};
        let activeInteraction = null;
        let activeElement = null;
        let startX = 0, startY = 0;
        let startWidth = 0, startHeight = 0;
        let startLeft = 0, startTop = 0;
        let selectedImageId = null;
        let selectedTextId = null;
        let selectedSoundId = null;
        let actionHistory = [];
        let historyPointer = -1;
        let resizeDirection = null;
        let isAddingText = false;
        let soundInterval = null;
        
        let rotateCenterX = 0;
        let rotateCenterY = 0;
        let initialAngle = 0;
        let isRotating = false;
        let isFlippedHorizontal = false;
        let isFlippedVertical = false;
       
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        let voices = [];
        let isTTSInitialized = false;
        
        function initApp() {
            console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
           
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            document.getElementById('sound-input').addEventListener('change', handleSoundUpload);
            document.getElementById('clear-btn').addEventListener('click', clearCanvas);
            document.getElementById('close-properties').addEventListener('click', () => {
                document.getElementById('properties-panel').style.display = 'none';
            });
           
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ URL
            document.getElementById('load-from-url-btn').addEventListener('click', showURLModal);
            document.getElementById('cancel-url').addEventListener('click', hideURLModal);
            document.getElementById('load-url').addEventListener('click', loadImageFromURL);
            document.getElementById('url-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    loadImageFromURL();
                }
            });
           
            // –ö–Ω–æ–ø–∫–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
            document.getElementById('transform-btn').addEventListener('click', showTransformPanel);
            document.getElementById('close-transform').addEventListener('click', closeTransformPanel);
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            document.getElementById('rotation-slider').addEventListener('input', updateRotationFromSlider);
            document.getElementById('scale-x-slider').addEventListener('input', updateScaleXFromSlider);
            document.getElementById('scale-y-slider').addEventListener('input', updateScaleYFromSlider);
            document.getElementById('skew-x-slider').addEventListener('input', updateSkewXFromSlider);
            document.getElementById('skew-y-slider').addEventListener('input', updateSkewYFromSlider);
            document.getElementById('flip-horizontal-btn').addEventListener('click', flipHorizontal);
            document.getElementById('flip-vertical-btn').addEventListener('click', flipVertical);
            document.getElementById('reset-transform-btn').addEventListener('click', resetTransform);
            
            // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
            document.getElementById('add-text-btn').addEventListener('click', showSimpleTextInput);
            document.getElementById('apply-text-simple').addEventListener('click', createTextFromSimpleInput);
            document.getElementById('cancel-text-simple').addEventListener('click', cancelSimpleTextInput);
            
            // –°–æ–±—ã—Ç–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.getElementById('edit-text-btn').addEventListener('click', editSelectedText);
            document.getElementById('delete-text-btn').addEventListener('click', deleteSelectedText);
            document.getElementById('lock-text-btn').addEventListener('click', toggleTextLock);
            document.getElementById('hide-text-btn').addEventListener('click', toggleTextVisibility);
           
            document.getElementById('speak-text-btn').addEventListener('click', showTTSPanel);
           
            document.getElementById('add-sound-btn').addEventListener('click', () => {
                document.getElementById('sound-input').click();
            });
           
            document.getElementById('play-btn').addEventListener('click', playSound);
            document.getElementById('pause-btn').addEventListener('click', pauseSound);
            document.getElementById('delete-sound-btn').addEventListener('click', deleteSound);
            document.getElementById('volume-slider').addEventListener('input', updateVolume);
           
            initTTS();
           
            document.getElementById('tts-play-btn').addEventListener('click', playTTS);
            document.getElementById('tts-pause-btn').addEventListener('click', pauseTTS);
            document.getElementById('tts-stop-btn').addEventListener('click', stopTTS);
            document.getElementById('tts-close-btn').addEventListener('click', closeTTSPanel);
            document.getElementById('tts-voice-select').addEventListener('change', updateTTSVoice);
           
            document.getElementById('tts-rate-slider').addEventListener('input', function() {
                document.getElementById('tts-rate-value').textContent = this.value;
                updateTTSRate.call(this);
            });
           
            document.getElementById('tts-pitch-slider').addEventListener('input', function() {
                document.getElementById('tts-pitch-value').textContent = this.value;
                updateTTSPitch.call(this);
            });
           
            document.getElementById('tts-volume-slider').addEventListener('input', function() {
                document.getElementById('tts-volume-value').textContent = this.value;
                updateTTSVolume.call(this);
            });
           
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞ –≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –ø–∞–Ω–µ–ª–∏
            document.getElementById('font-size-slider').addEventListener('input', updateTextPreview);
            document.getElementById('text-color-picker').addEventListener('input', updateTextPreview);
            document.getElementById('font-family-select').addEventListener('change', updateTextPreview);
            document.getElementById('text-input-area').addEventListener('input', updateTextPreview);
           
            document.getElementById('images-layer').addEventListener('mousedown', (e) => {
                if (e.target === document.getElementById('images-layer')) {
                    deselectAllElements();
                }
            });
            
            document.getElementById('texts-layer').addEventListener('mousedown', (e) => {
                if (e.target === document.getElementById('texts-layer')) {
                    deselectAllElements();
                }
            });
           
            document.getElementById('opacity-slider').addEventListener('input', (e) => {
                if (selectedImageId) {
                    const opacity = e.target.value / 100;
                    const imgElement = document.getElementById(selectedImageId);
                    if (imgElement) {
                        imgElement.style.opacity = opacity;
                    }
                    imagesRef.child(selectedImageId).update({ opacity: opacity });
                    saveStateToHistory();
                }
            });
           
            document.getElementById('brightness-slider').addEventListener('input', (e) => {
                if (selectedImageId) {
                    const brightness = e.target.value;
                    const imgElement = document.getElementById(selectedImageId);
                    if (imgElement) {
                        imgElement.style.filter = `brightness(${brightness}%)`;
                    }
                    imagesRef.child(selectedImageId).update({ brightness: brightness });
                    saveStateToHistory();
                }
            });
           
            document.getElementById('hide-btn').addEventListener('click', () => {
                if (selectedImageId) {
                    const imgElement = document.getElementById(selectedImageId);
                    if (!imgElement) return;
                   
                    const isHidden = imgElement.style.display === 'none';
                   
                    if (isHidden) {
                        imgElement.style.display = 'block';
                        imagesRef.child(selectedImageId).update({
                            display: 'block'
                        });
                    } else {
                        imgElement.style.display = 'none';
                        imagesRef.child(selectedImageId).update({
                            display: 'none'
                        });
                    }
                   
                    saveStateToHistory();
                }
            });
           
            document.getElementById('delete-btn').addEventListener('click', () => {
                if (selectedImageId && confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?")) {
                    imagesRef.child(selectedImageId).remove();
                    deselectAllElements();
                    saveStateToHistory();
                }
            });
           
            document.getElementById('settings-btn').addEventListener('click', () => {
                if (selectedImageId) {
                    const panel = document.getElementById('properties-panel');
                    const opacitySlider = document.getElementById('opacity-slider');
                    const brightnessSlider = document.getElementById('brightness-slider');
                   
                    const imgElement = document.getElementById(selectedImageId);
                    const currentOpacity = parseFloat(imgElement.style.opacity) || 1;
                    opacitySlider.value = currentOpacity * 100;
                   
                    const currentBrightness = imgElement.style.filter.includes('brightness') ?
                        parseInt(imgElement.style.filter.match(/brightness\((\d+)%\)/)[1]) : 100;
                    brightnessSlider.value = currentBrightness;
                   
                    panel.style.display = 'block';
                }
            });
           
            document.getElementById('lock-btn').addEventListener('click', () => {
                if (selectedImageId) {
                    const imgElement = document.getElementById(selectedImageId);
                    if (!imgElement) return;
                   
                    const isLocked = imgElement.classList.contains('locked');
                   
                    if (isLocked) {
                        imgElement.classList.remove('locked');
                        document.getElementById('lock-btn').textContent = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
                    } else {
                        imgElement.classList.add('locked');
                        document.getElementById('lock-btn').textContent = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å';
                    }
                   
                    imagesRef.child(selectedImageId).update({
                        locked: !isLocked
                    });
                    saveStateToHistory();
                }
            });
           
            imagesRef.on('value', (snapshot) => {
                try {
                    const data = snapshot.val() || {};
                    console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:", data);
                    images = data;
                    updateCanvas(data);
                    updateThumbnails();
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:", error);
                }
            });
           
            textsRef.on('value', (snapshot) => {
                try {
                    const data = snapshot.val() || {};
                    console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤:", data);
                    texts = data;
                    updateTexts(data);
                    updateThumbnails();
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–æ–≤:", error);
                }
            });
           
            soundsRef.on('value', (snapshot) => {
                try {
                    const data = snapshot.val() || {};
                    console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–≤—É–∫–æ–≤:", data);
                    sounds = data;
                    updateThumbnails();
                   
                    if (selectedSoundId && !sounds[selectedSoundId]) {
                        selectedSoundId = null;
                        document.getElementById('sound-controls').style.display = 'none';
                    }
                   
                    if (selectedSoundId && sounds[selectedSoundId]) {
                        updateSoundControls(sounds[selectedSoundId]);
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–≤—É–∫–æ–≤:", error);
                }
            });
           
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('mouseup', endInteraction);
            document.addEventListener('touchend', endInteraction);
           
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undoAction();
                }
                if (e.key === 'Escape' && isAddingText) {
                    cancelSimpleTextInput();
                }
                if (e.key === 'Enter' && e.ctrlKey && isAddingText) {
                    createTextFromSimpleInput();
                }
                if (e.key === 'Escape') {
                    hideURLModal();
                    closeTransformPanel();
                    closeTTSPanel();
                }
            });
           
            const audioElement = document.getElementById('audio-element');
            audioElement.addEventListener('timeupdate', updateSoundProgress);
            audioElement.addEventListener('ended', soundEnded);
           
            setupViewport();
           
            console.log("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ");
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ URL
        function showURLModal() {
            const modal = document.getElementById('url-modal');
            const input = document.getElementById('url-input');
            input.value = 'https://lowka227.github.io/sd/';
            input.focus();
            modal.style.display = 'flex';
        }
        
        function hideURLModal() {
            document.getElementById('url-modal').style.display = 'none';
        }
        
        function loadImageFromURL() {
            const urlInput = document.getElementById('url-input');
            let url = urlInput.value.trim();
            
            if (!url) {
                alert("–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL
            if (!isValidURL(url)) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL");
                return;
            }
            
            // –ï—Å–ª–∏ URL –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ /, –¥–æ–±–∞–≤–ª—è–µ–º test.png –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
            if (url.endsWith('/')) {
                url = url + 'test.png';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            document.getElementById('status').style.color = '#fbbc05';
            
            const img = new Image();
            img.crossOrigin = "anonymous";
            
            img.onload = function() {
                const id = 'img_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const x = 100;
                const y = 100;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ
                const maxWidth = 800;
                const maxHeight = 600;
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = Math.floor(width * ratio);
                    height = Math.floor(height * ratio);
                }
                
                // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ data URL
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                const dataURL = canvas.toDataURL('image/png');
                
                imagesRef.child(id).set({
                    id: id,
                    src: dataURL,
                    x: x,
                    y: y,
                    width: width,
                    height: height,
                    opacity: 1,
                    brightness: 100,
                    isNew: true,
                    locked: false,
                    display: 'block',
                    source: 'url',
                    originalUrl: url
                });
                
                saveStateToHistory();
                hideURLModal();
                document.getElementById('status').textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                document.getElementById('status').style.color = '#666';
            };
            
            img.onerror = function() {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É URL\n" + 
                      "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è");
                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                document.getElementById('status').style.color = '#ea4335';
                setTimeout(() => {
                    document.getElementById('status').textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
                    document.getElementById('status').style.color = '#666';
                }, 3000);
            };
            
            img.src = url;
        }
        
        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function showTransformPanel() {
            if (!selectedImageId) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
                return;
            }
            
            const panel = document.getElementById('transform-panel');
            const imgElement = document.getElementById(selectedImageId);
            
            if (!imgElement) return;
            
            const style = window.getComputedStyle(imgElement);
            const transform = style.transform || 'none';
            
            let rotation = 0;
            let scaleX = 100;
            let scaleY = 100;
            let skewX = 0;
            let skewY = 0;
            
            if (transform !== 'none') {
                const matrix = new DOMMatrix(transform);
                
                rotation = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
                if (rotation < 0) rotation += 360;
                
                const scaleXSign = matrix.a < 0 ? -1 : 1;
                const scaleYSign = matrix.d < 0 ? -1 : 1;
                scaleX = Math.sqrt(matrix.a * matrix.a + matrix.b * matrix.b) * 100 * scaleXSign;
                scaleY = Math.sqrt(matrix.c * matrix.c + matrix.d * matrix.d) * 100 * scaleYSign;
                
                skewX = Math.atan2(matrix.c, matrix.d) * (180 / Math.PI);
                skewY = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI) - rotation;
            }
            
            // –£–±–∏—Ä–∞–µ–º –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Ä–∞—Å—á–µ—Ç–∞ scale
            scaleX = Math.abs(scaleX);
            scaleY = Math.abs(scaleY);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Ä–∞–∂–µ–Ω–∏—è
            const currentTransform = imgElement.style.transform || '';
            isFlippedHorizontal = currentTransform.includes('scaleX(-1)') || scaleX < 0;
            isFlippedVertical = currentTransform.includes('scaleY(-1)') || scaleY < 0;
            
            document.getElementById('rotation-slider').value = rotation;
            document.getElementById('rotation-value').textContent = rotation.toFixed(0) + '¬∞';
            
            document.getElementById('scale-x-slider').value = scaleX;
            document.getElementById('scale-x-value').textContent = scaleX.toFixed(0) + '%';
            
            document.getElementById('scale-y-slider').value = scaleY;
            document.getElementById('scale-y-value').textContent = scaleY.toFixed(0) + '%';
            
            document.getElementById('skew-x-slider').value = skewX;
            document.getElementById('skew-x-value').textContent = skewX.toFixed(0) + '¬∞';
            
            document.getElementById('skew-y-slider').value = skewY;
            document.getElementById('skew-y-value').textContent = skewY.toFixed(0) + '¬∞';
            
            panel.style.display = 'block';
        }
        
        function closeTransformPanel() {
            document.getElementById('transform-panel').style.display = 'none';
        }
        
        function updateRotationFromSlider() {
            if (!selectedImageId) return;
            
            const rotation = parseInt(this.value);
            document.getElementById('rotation-value').textContent = rotation + '¬∞';
            
            applyTransform();
        }
        
        function updateScaleXFromSlider() {
            if (!selectedImageId) return;
            
            const scaleX = parseInt(this.value);
            document.getElementById('scale-x-value').textContent = scaleX + '%';
            
            applyTransform();
        }
        
        function updateScaleYFromSlider() {
            if (!selectedImageId) return;
            
            const scaleY = parseInt(this.value);
            document.getElementById('scale-y-value').textContent = scaleY + '%';
            
            applyTransform();
        }
        
        function updateSkewXFromSlider() {
            if (!selectedImageId) return;
            
            const skewX = parseInt(this.value);
            document.getElementById('skew-x-value').textContent = skewX + '¬∞';
            
            applyTransform();
        }
        
        function updateSkewYFromSlider() {
            if (!selectedImageId) return;
            
            const skewY = parseInt(this.value);
            document.getElementById('skew-y-value').textContent = skewY + '¬∞';
            
            applyTransform();
        }
        
        function applyTransform() {
            if (!selectedImageId) return;
            
            const imgElement = document.getElementById(selectedImageId);
            if (!imgElement) return;
            
            const rotation = parseInt(document.getElementById('rotation-slider').value);
            const scaleX = parseInt(document.getElementById('scale-x-slider').value) / 100;
            const scaleY = parseInt(document.getElementById('scale-y-slider').value) / 100;
            const skewX = parseInt(document.getElementById('skew-x-slider').value);
            const skewY = parseInt(document.getElementById('skew-y-slider').value);
            
            let transform = '';
            
            if (rotation !== 0) {
                transform += `rotate(${rotation}deg) `;
            }
            
            if (skewX !== 0) {
                transform += `skewX(${skewX}deg) `;
            }
            if (skewY !== 0) {
                transform += `skewY(${skewY}deg) `;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ
            let scaleTransform = '';
            let finalScaleX = scaleX;
            let finalScaleY = scaleY;
            
            if (isFlippedHorizontal) {
                finalScaleX *= -1;
            }
            if (isFlippedVertical) {
                finalScaleY *= -1;
            }
            
            if (finalScaleX !== 1 || finalScaleY !== 1) {
                scaleTransform = `scale(${finalScaleX}, ${finalScaleY})`;
            }
            
            transform += scaleTransform;
            
            imgElement.style.transform = transform.trim();
            
            imagesRef.child(selectedImageId).update({
                transform: transform.trim(),
                rotation: rotation,
                scaleX: scaleX * 100,
                scaleY: scaleY * 100,
                skewX: skewX,
                skewY: skewY,
                flippedHorizontal: isFlippedHorizontal,
                flippedVertical: isFlippedVertical
            });
            
            saveStateToHistory();
        }
        
        function flipHorizontal() {
            if (!selectedImageId) return;
            
            isFlippedHorizontal = !isFlippedHorizontal;
            applyTransform();
        }
        
        function flipVertical() {
            if (!selectedImageId) return;
            
            isFlippedVertical = !isFlippedVertical;
            applyTransform();
        }
        
        function resetTransform() {
            if (!selectedImageId) return;
            
            document.getElementById('rotation-slider').value = 0;
            document.getElementById('scale-x-slider').value = 100;
            document.getElementById('scale-y-slider').value = 100;
            document.getElementById('skew-x-slider').value = 0;
            document.getElementById('skew-y-slider').value = 0;
            
            document.getElementById('rotation-value').textContent = '0¬∞';
            document.getElementById('scale-x-value').textContent = '100%';
            document.getElementById('scale-y-value').textContent = '100%';
            document.getElementById('skew-x-value').textContent = '0¬∞';
            document.getElementById('skew-y-value').textContent = '0¬∞';
            
            isFlippedHorizontal = false;
            isFlippedVertical = false;
            
            applyTransform();
        }
        
        function startRotation(e) {
            if (!selectedImageId) return;
            
            const imgElement = document.getElementById(selectedImageId);
            if (!imgElement || imgElement.classList.contains('locked')) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            isRotating = true;
            activeInteraction = 'rotate';
            activeElement = imgElement;
            
            const rect = imgElement.getBoundingClientRect();
            rotateCenterX = rect.left + rect.width / 2;
            rotateCenterY = rect.top + rect.height / 2;
            
            const style = window.getComputedStyle(imgElement);
            const transform = style.transform || 'none';
            let currentRotation = 0;
            
            if (transform !== 'none') {
                const matrix = new DOMMatrix(transform);
                currentRotation = Math.atan2(matrix.b, matrix.a) * (180 / Math.PI);
                if (currentRotation < 0) currentRotation += 360;
            }
            
            initialAngle = currentRotation;
            
            let rotationIndicator = imgElement.querySelector('.rotation-indicator');
            if (!rotationIndicator) {
                rotationIndicator = document.createElement('div');
                rotationIndicator.className = 'rotation-indicator';
                imgElement.appendChild(rotationIndicator);
            }
            imgElement.classList.add('dragging');
            
            if (e.type === 'touchstart') {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            } else {
                startX = e.clientX;
                startY = e.clientY;
            }
        }
        
        function updateRotation(e) {
            if (!isRotating || !activeElement) return;
            
            let clientX, clientY;
            
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const dx = clientX - rotateCenterX;
            const dy = clientY - rotateCenterY;
            const currentAngle = Math.atan2(dy, dx) * (180 / Math.PI);
            
            const startDx = startX - rotateCenterX;
            const startDy = startY - rotateCenterY;
            const startAngle = Math.atan2(startDy, startDx) * (180 / Math.PI);
            
            let deltaAngle = currentAngle - startAngle;
            
            let newRotation = initialAngle + deltaAngle;
            if (newRotation < 0) newRotation += 360;
            if (newRotation >= 360) newRotation -= 360;
            
            const rotationIndicator = activeElement.querySelector('.rotation-indicator');
            if (rotationIndicator) {
                rotationIndicator.textContent = newRotation.toFixed(0) + '¬∞';
            }
            
            const style = window.getComputedStyle(activeElement);
            const currentTransform = style.transform || 'none';
            
            let transform = currentTransform.replace(/rotate\([^)]*\)\s*/g, '');
            
            transform = `rotate(${newRotation}deg) ${transform}`.trim();
            
            activeElement.style.transform = transform;
            
            document.getElementById('rotation-slider').value = newRotation;
            document.getElementById('rotation-value').textContent = newRotation.toFixed(0) + '¬∞';
            
            imagesRef.child(activeElement.id).update({
                transform: transform,
                rotation: newRotation
            });
        }
        
        function endRotation() {
            if (isRotating && activeElement) {
                saveStateToHistory();
                
                const rotationIndicator = activeElement.querySelector('.rotation-indicator');
                if (rotationIndicator) {
                    setTimeout(() => {
                        activeElement.classList.remove('dragging');
                    }, 300);
                }
            }
            
            isRotating = false;
            activeInteraction = null;
            activeElement = null;
        }
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (handleMove, endInteraction, –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ
        // –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ, —è –∏—Ö –ø—Ä–æ–ø—É—â—É –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
        // –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
        function showSimpleTextInput() {
            try {
                deselectAllElements();
                const panel = document.getElementById('simple-text-input');
                const textarea = document.getElementById('text-input-area');
                
                const canvasWrapper = document.getElementById('canvas-wrapper');
                const centerX = canvasWrapper.offsetWidth / 2;
                const centerY = canvasWrapper.offsetHeight / 2;
                
                panel.style.left = (centerX - 150) + 'px';
                panel.style.top = (centerY - 100) + 'px';
                panel.style.display = 'block';
                
                textarea.value = '';
                textarea.style.fontSize = '16px';
                textarea.style.color = '#000000';
                textarea.style.fontFamily = "'Comic Sans MS', cursive";
                
                document.getElementById('font-size-slider').value = 16;
                document.getElementById('text-color-picker').value = '#000000';
                document.getElementById('font-family-select').value = "'Comic Sans MS', cursive";
                
                isAddingText = true;
                setTimeout(() => textarea.focus(), 100);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ø–∞–Ω–µ–ª–∏ —Ç–µ–∫—Å—Ç–∞:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞");
            }
        }
        
        // ... [–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ] ...
        // –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –ø—Ä–æ–ø—É—â—É –∏—Ö, –Ω–æ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º –∫–æ–¥–µ
        
        // –í–∞–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        function handleMove(e) {
            if (isRotating) {
                updateRotation(e);
                return;
            }
            
            if (!activeInteraction || !activeElement) return;
            if (activeElement.classList.contains('locked')) return;
           
            e.preventDefault();
            let clientX, clientY;
           
            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
           
            if (activeInteraction === 'select' || activeInteraction === 'drag') {
                const x = clientX - startX;
                const y = clientY - startY;
               
                const container = document.getElementById('canvas-wrapper');
                const maxX = container.offsetWidth - activeElement.offsetWidth;
                const maxY = container.offsetHeight - activeElement.offsetHeight;
               
                const boundedX = Math.max(0, Math.min(x, maxX));
                const boundedY = Math.max(0, Math.min(y, maxY));
               
                activeElement.style.left = boundedX + 'px';
                activeElement.style.top = boundedY + 'px';
               
                if (activeElement.classList.contains('draggable-image')) {
                    imagesRef.child(activeElement.id).update({
                        x: boundedX,
                        y: boundedY
                    });
                } else if (activeElement.classList.contains('draggable-text')) {
                    textsRef.child(activeElement.id).update({
                        x: boundedX,
                        y: boundedY
                    });
                }
               
                if (activeInteraction === 'select') {
                    activeInteraction = 'drag';
                }
            }
            else if (activeInteraction === 'resize') {
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
               
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
               
                switch (resizeDirection) {
                    case 'n':
                        newHeight = Math.max(20, startHeight - deltaY);
                        newTop = startTop + (startHeight - newHeight);
                        break;
                    case 'ne':
                        newHeight = Math.max(20, startHeight - deltaY);
                        newTop = startTop + (startHeight - newHeight);
                        newWidth = Math.max(20, startWidth + deltaX);
                        break;
                    case 'e':
                        newWidth = Math.max(20, startWidth + deltaX);
                        break;
                    case 'se':
                        newWidth = Math.max(20, startWidth + deltaX);
                        newHeight = Math.max(20, startHeight + deltaY);
                        break;
                    case 's':
                        newHeight = Math.max(20, startHeight + deltaY);
                        break;
                    case 'sw':
                        newWidth = Math.max(20, startWidth - deltaX);
                        newLeft = startLeft + (startWidth - newWidth);
                        newHeight = Math.max(20, startHeight + deltaY);
                        break;
                    case 'w':
                        newWidth = Math.max(20, startWidth - deltaX);
                        newLeft = startLeft + (startWidth - newWidth);
                        break;
                    case 'nw':
                        newWidth = Math.max(20, startWidth - deltaX);
                        newLeft = startLeft + (startWidth - newWidth);
                        newHeight = Math.max(20, startHeight - deltaY);
                        newTop = startTop + (startHeight - newHeight);
                        break;
                }
               
                activeElement.style.width = newWidth + 'px';
                activeElement.style.height = newHeight + 'px';
                activeElement.style.left = newLeft + 'px';
                activeElement.style.top = newTop + 'px';
               
                if (activeElement.classList.contains('draggable-image')) {
                    imagesRef.child(activeElement.id).update({
                        width: newWidth,
                        height: newHeight,
                        x: newLeft,
                        y: newTop
                    });
                } else if (activeElement.classList.contains('draggable-text')) {
                    textsRef.child(activeElement.id).update({
                        x: newLeft,
                        y: newTop
                    });
                }
            }
        }
        
        function endInteraction() {
            endRotation();
            
            if (activeInteraction && activeInteraction !== 'rotate') {
                saveStateToHistory();
            }
            activeInteraction = null;
            activeElement = null;
            resizeDirection = null;
        }
        
        function createImageElement(imgData) {
            const imgWrapper = document.createElement('div');
            imgWrapper.id = imgData.id;
            imgWrapper.className = 'draggable-image';
            imgWrapper.style.left = imgData.x + 'px';
            imgWrapper.style.top = imgData.y + 'px';
            imgWrapper.style.width = imgData.width + 'px';
            imgWrapper.style.height = imgData.height + 'px';
            imgWrapper.style.opacity = imgData.opacity !== undefined ? imgData.opacity : 1;
            imgWrapper.style.filter = `brightness(${imgData.brightness !== undefined ? imgData.brightness : 100}%)`;
           
            if (imgData.transform) {
                imgWrapper.style.transform = imgData.transform;
            }
           
            if (imgData.locked) {
                imgWrapper.classList.add('locked');
            }
           
            if (imgData.display === 'none') {
                imgWrapper.style.display = 'none';
            } else {
                imgWrapper.style.display = 'block';
            }
           
            const img = document.createElement('img');
            img.src = imgData.src;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'fill';
            img.draggable = false;
            imgWrapper.appendChild(img);
           
            addResizeHandles(imgWrapper);
           
            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'rotate-handle';
            imgWrapper.appendChild(rotateHandle);
           
            rotateHandle.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('rotate-handle')) {
                    startRotation(e);
                }
            });
            rotateHandle.addEventListener('touchstart', (e) => {
                if (e.target.classList.contains('rotate-handle')) {
                    startRotation(e);
                }
            }, { passive: false });
           
            imgWrapper.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle') || 
                    e.target.classList.contains('rotate-handle')) return;
                startSelect(e);
            });
            imgWrapper.addEventListener('touchstart', (e) => {
                if (e.target.classList.contains('resize-handle') ||
                    e.target.classList.contains('rotate-handle')) return;
                startSelect(e);
            }, { passive: false });
           
            return imgWrapper;
        }
        
        function addResizeHandles(element) {
            element.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
           
            const directions = ['n', 'ne', 'e', 'se', 's', 'sw', 'w', 'nw'];
           
            directions.forEach(dir => {
                const handle = document.createElement('div');
                handle.className = `resize-handle resize-${dir}`;
                element.appendChild(handle);
               
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    startResize(e, dir);
                });
               
                handle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    startResize(e, dir);
                }, { passive: false });
            });
        }
        
        function startResize(e, direction) {
            if (e.currentTarget.parentElement.classList.contains('locked')) return;
           
            e.preventDefault();
            e.stopPropagation();
           
            activeInteraction = 'resize';
            activeElement = e.currentTarget.parentElement;
            resizeDirection = direction;
           
            const rect = activeElement.getBoundingClientRect();
            if (e.type === 'touchstart') {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            } else {
                startX = e.clientX;
                startY = e.clientY;
            }
           
            startWidth = parseFloat(activeElement.style.width) || activeElement.offsetWidth;
            startHeight = parseFloat(activeElement.style.height) || activeElement.offsetHeight;
            startLeft = parseFloat(activeElement.style.left) || 0;
            startTop = parseFloat(activeElement.style.top) || 0;
        }
        
        function startSelect(e) {
            e.preventDefault();
            e.stopPropagation();
           
            const imgElement = e.currentTarget;
            const isLocked = imgElement.classList.contains('locked');
           
            deselectAllElements();
           
            imgElement.classList.add('selected');
            selectedImageId = imgElement.id;
            document.getElementById('image-controls').style.display = 'flex';
           
            const lockBtn = document.getElementById('lock-btn');
            lockBtn.textContent = isLocked ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
           
            if (!isLocked) {
                activeInteraction = 'select';
                activeElement = imgElement;
               
                const currentX = parseInt(imgElement.style.left) || 0;
                const currentY = parseInt(imgElement.style.top) || 0;
               
                if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX - currentX;
                    startY = e.touches[0].clientY - currentY;
                } else {
                    startX = e.clientX - currentX;
                    startY = e.clientY - currentY;
                }
            }
        }
        
        // ... [–¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ] ...
        
        window.addEventListener('DOMContentLoaded', initApp);
        window.addEventListener('resize', setupViewport);
        
        function setupViewport() {
            const appContainer = document.getElementById('app-container');
            const scale = Math.min(
                window.innerWidth / 2560,
                window.innerHeight / 1212
            );
            appContainer.style.transform = `scale(${scale})`;
            appContainer.style.transformOrigin = 'top left';
        }
    </script>
</body>
</html>
