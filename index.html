<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прозрачный оверлей для OBS</title>
    <style>
        * { -webkit-app-region: no-drag; user-select: none; }
        body {
            margin: 0; padding: 0; font-family: Arial, sans-serif;
            overflow: hidden; touch-action: none; background: transparent !important;
        }
        #app-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; flex-direction: column;
        }
        #controls {
            background: rgba(240,240,240,0.9); backdrop-filter: blur(5px);
            padding: 10px; display: flex; gap: 10px; align-items: center;
            height: 60px; box-sizing: border-box; z-index: 100; flex-shrink: 0;
        }
        #thumbnails-container {
            display: flex; align-items: center; overflow-x: auto;
            margin-left: 20px; height: 60px; background: rgba(224,224,224,0.8);
            border-radius: 4px; padding: 0 10px; flex-grow: 1;
        }
        #thumbnails { display: flex; gap: 10px; }
        .thumbnail {
            position: relative; width: 40px; height: 40px; flex-shrink: 0;
            border: 2px solid transparent; cursor: pointer;
        }
        .thumbnail img { width: 100%; height: 100%; object-fit: cover; }
        .text-thumbnail, .sound-thumbnail {
            display: flex; align-items: center; justify-content: center;
            background: #f0f0f0; border-radius: 3px; font-size: 10px;
            overflow: hidden; text-overflow: ellipsis; padding: 0 5px;
            text-align: center; width: 100%; height: 100%;
        }
        .sound-thumbnail { background: #e0e0ff; }
        .thumbnail.selected { border-color: #4285f4; }
        .thumbnail-hidden { opacity: 0.5; }
        .thumbnail-button {
            position: absolute; top: -5px; right: -5px; width: 16px; height: 16px;
            border: none; border-radius: 50%; background: #f44336; color: white;
            font-size: 12px; line-height: 1; cursor: pointer; padding: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .thumbnail-button.show { background: #4caf50; }

        #image-controls, #text-controls, #sound-controls {
            display: flex; gap: 10px; margin-left: 20px; display: none; align-items: center;
        }

        #canvas-wrapper { flex: 1; position: relative; overflow: hidden; background: transparent; }

        #elements-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2; pointer-events: none;
        }

        .draggable-image, .draggable-text {
            position: absolute; cursor: move; user-select: none; touch-action: none;
            transition: opacity 0.3s, filter 0.3s; opacity: 0.3; box-sizing: border-box;
            filter: brightness(85%); pointer-events: auto; mix-blend-mode: normal;
            isolation: isolate; background-color: rgba(0,0,0,0.01);
        }
        .draggable-image img {
            width: 100%; height: 100%; object-fit: contain; pointer-events: none;
        }
        .draggable-text {
            white-space: nowrap; background-color: rgba(255,255,255,0.7);
            padding: 2px 5px; border-radius: 3px; transform-origin: top left;
        }

        .selected { box-shadow: 0 0 0 2px #4285f4 inset; }
        .locked { box-shadow: 0 0 0 2px #ff0000 inset !important; }

        .resize-handle {
            position: absolute; width: 10px; height: 10px; background-color: #4285f4;
            border: 1px solid white; z-index: 10; opacity: 0; transition: opacity 0.2s;
        }
        .selected:not(.locked) .resize-handle { opacity: 1; }
        .resize-n { top: -5px; left: 50%; margin-left: -5px; cursor: n-resize; }
        .resize-ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-e { top: 50%; right: -5px; margin-top: -5px; cursor: e-resize; }
        .resize-se { bottom: -5px; right: -5px; cursor: se-resize; }
        .resize-s { bottom: -5px; left: 50%; margin-left: -5px; cursor: s-resize; }
        .resize-sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-w { top: 50%; left: -5px; margin-top: -5px; cursor: w-resize; }
        .resize-nw { top: -5px; left: -5px; cursor: nw-resize; }

        button {
            padding: 8px 12px; border: none; border-radius: 4px;
            background: #4285f4; color: white; font-size: 14px; cursor: pointer;
        }
        #file-input, #sound-input { display: none; }
        #status { margin-left: 10px; font-size: 14px; color: #666; white-space: nowrap; }

        .properties-panel, #text-input-panel, #tts-panel {
            position: fixed; background: white; padding: 15px;
            border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100; display: none;
        }
        .properties-panel { top: 80px; right: 20px; }
        #text-input-panel { top: 80px; left: 20px; }
        #tts-panel { top: 80px; right: 20px; width: 320px; }

        .sound-visualization {
            width: 100px; height: 30px; background: #ddd; border-radius: 4px;
            overflow: hidden; position: relative;
        }
        .sound-progress { height: 100%; background: #4285f4; width: 0%; transition: width 0.1s; }
        #audio-element { display: none; }

        .volume-control { display: flex; align-items: center; gap: 5px; }
        .volume-slider { width: 80px; }

        .tts-controls-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .tts-voice-select { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .tts-control-label { font-size: 12px; color: #666; white-space: nowrap; min-width: 60px; }
        .tts-slider { flex: 1; }
        .tts-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .tts-buttons button { flex: 1; }
        #tts-play-btn { background: #4caf50; }
        #tts-pause-btn { background: #ff9800; }
        #tts-stop-btn { background: #f44336; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="controls">
            <button onclick="document.getElementById('file-input').click()">Изображение</button>
            <button id="add-text-btn">Текст</button>
            <button id="add-sound-btn">Звук</button>
            <button id="speak-text-btn">Озвучить</button>
            <button id="clear-btn">Очистить</button>

            <div id="thumbnails-container">
                <div id="thumbnails"></div>
            </div>

            <div id="image-controls">
                <button id="hide-btn">Скрыть/Показать</button>
                <button id="delete-btn">Удалить</button>
                <button id="settings-btn">Настройки</button>
                <button id="lock-btn">Закрепить</button>
            </div>

            <div id="text-controls">
                <button id="hide-text-btn">Скрыть/Показать</button>
                <button id="edit-text-btn">Редактировать</button>
                <button id="delete-text-btn">Удалить</button>
                <button id="lock-text-btn">Закрепить</button>
            </div>

            <div id="sound-controls">
                <button id="play-btn">Play</button>
                <button id="pause-btn">Pause</button>
                <div class="sound-visualization">
                    <div class="sound-progress" id="sound-progress"></div>
                </div>
                <div class="volume-control">
                    <span>Volume</span>
                    <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100">
                </div>
                <button id="delete-sound-btn">Удалить</button>
            </div>

            <div id="status">Синхронизировано</div>
        </div>

        <div id="canvas-wrapper">
            <div id="elements-layer"></div>
        </div>
    </div>

    <div class="properties-panel" id="properties-panel">
        <h3>Свойства изображения</h3>
        <label>Прозрачность: <input type="range" id="opacity-slider" min="0" max="100" value="30"></label>
        <label>Яркость: <input type="range" id="brightness-slider" min="0" max="200" value="85"></label>
        <button id="close-properties">Закрыть</button>
    </div>

    <div id="text-input-panel">
        <h3 id="text-panel-title">Добавить текст</h3>
        <input type="text" id="text-input" placeholder="Введите текст">
        <label>Размер: <input type="range" id="font-size-input" min="10" max="72" value="16"></label>
        <label>Цвет: <input type="color" id="text-color-input" value="#000000"></label>
        <label>Шрифт:
            <select id="font-family-select">
                <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="Impact, sans-serif">Impact</option>
                <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
            </select>
        </label>
        <button id="apply-text-btn">Применить</button>
        <button id="cancel-text-btn">Отмена</button>
    </div>

    <div id="tts-panel">
        <h3>Озвучивание текста</h3>
        <textarea id="tts-text-input" placeholder="Введите текст..."></textarea>
        <div class="tts-controls-row">
            <select id="tts-voice-select" class="tts-voice-select"><option value="">Выберите голос...</option></select>
        </div>
        <div class="tts-controls-row">
            <span class="tts-control-label">Скорость:</span>
            <input type="range" class="tts-slider" id="tts-rate-slider" min="0.5" max="2" step="0.1" value="1">
            <span class="tts-control-label" id="tts-rate-value">1.0</span>
        </div>
        <div class="tts-controls-row">
            <span class="tts-control-label">Высота:</span>
            <input type="range" class="tts-slider" id="tts-pitch-slider" min="0.5" max="2" step="0.1" value="1">
            <span class="tts-control-label" id="tts-pitch-value">1.0</span>
        </div>
        <div class="tts-controls-row">
            <span class="tts-control-label">Громкость:</span>
            <input type="range" class="tts-slider" id="tts-volume-slider" min="0" max="1" step="0.1" value="1">
            <span class="tts-control-label" id="tts-volume-value">1.0</span>
        </div>
        <div class="tts-buttons">
            <button id="tts-play-btn">Play</button>
            <button id="tts-pause-btn">Pause</button>
            <button id="tts-stop-btn">Stop</button>
        </div>
        <button id="tts-close-btn" style="margin-top:10px;width:100%;background:#666;">Закрыть</button>
    </div>

    <input type="file" id="file-input" accept="image/*">
    <input type="file" id="sound-input" accept="audio/*">
    <audio id="audio-element"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <script>
        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDNWDm3Rkvq4mV7Cvf5ckvZvDD5MNLDXoo",
            authDomain: "greenbackgroundapp.firebaseapp.com",
            databaseURL: "https://greenbackgroundapp-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "greenbackgroundapp",
            storageBucket: "greenbackgroundapp.appspot.com",
            messagingSenderId: "857271333291",
            appId: "1:857271333291:web:e754824268f37341c7e2ee"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.log("Firebase уже инициализирован"); }
        const database = firebase.database();
        const imagesRef = database.ref('images');
        const textsRef = database.ref('texts');
        const soundsRef = database.ref('sounds');

        // Переменные
        let images = {}, texts = {}, sounds = {};
        let activeInteraction = null, activeElement = null;
        let startX = 0, startY = 0, startWidth = 0, startHeight = 0, startLeft = 0, startTop = 0;
        let selectedImageId = null, selectedTextId = null, selectedSoundId = null;
        let actionHistory = [], historyPointer = -1;
        let resizeDirection = null;
        let isEditingText = false, currentTextId = null;
        let soundInterval = null;

        // TTS
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        let voices = [];
        let isTTSInitialized = false;

        // Инициализация
        function initApp() {
            document.getElementById('file-input').addEventListener('change', handleFileUpload);
            document.getElementById('sound-input').addEventListener('change', handleSoundUpload);
            document.getElementById('clear-btn').addEventListener('click', clearCanvas);
            document.getElementById('close-properties').addEventListener('click', () => { document.getElementById('properties-panel').style.display = 'none'; });

            document.getElementById('add-text-btn').addEventListener('click', showTextInputPanel);
            document.getElementById('apply-text-btn').addEventListener('click', applyTextChanges);
            document.getElementById('cancel-text-btn').addEventListener('click', cancelTextEdit);

            document.getElementById('edit-text-btn').addEventListener('click', editSelectedText);
            document.getElementById('delete-text-btn').addEventListener('click', deleteSelectedText);
            document.getElementById('lock-text-btn').addEventListener('click', toggleTextLock);
            document.getElementById('hide-text-btn').addEventListener('click', toggleTextVisibility);

            document.getElementById('speak-text-btn').addEventListener('click', showTTSPanel);
            document.getElementById('add-sound-btn').addEventListener('click', () => { document.getElementById('sound-input').click(); });

            document.getElementById('play-btn').addEventListener('click', playSound);
            document.getElementById('pause-btn').addEventListener('click', pauseSound);
            document.getElementById('delete-sound-btn').addEventListener('click', deleteSound);
            document.getElementById('volume-slider').addEventListener('input', updateVolume);

            initTTS();

            document.getElementById('tts-play-btn').addEventListener('click', playTTS);
            document.getElementById('tts-pause-btn').addEventListener('click', pauseTTS);
            document.getElementById('tts-stop-btn').addEventListener('click', stopTTS);
            document.getElementById('tts-close-btn').addEventListener('click', closeTTSPanel);
            document.getElementById('tts-voice-select').addEventListener('change', updateTTSVoice);

            document.getElementById('tts-rate-slider').addEventListener('input', function(){ document.getElementById('tts-rate-value').textContent=this.value; updateTTSRate.call(this); });
            document.getElementById('tts-pitch-slider').addEventListener('input', function(){ document.getElementById('tts-pitch-value').textContent=this.value; updateTTSPitch.call(this); });
            document.getElementById('tts-volume-slider').addEventListener('input', function(){ document.getElementById('tts-volume-value').textContent=this.value; updateTTSVolume.call(this); });

            document.getElementById('elements-layer').addEventListener('mousedown', e => { if (e.target===document.getElementById('elements-layer')) deselectAllElements(); });

            document.getElementById('opacity-slider').addEventListener('input', e => { if(selectedImageId){ const img=document.getElementById(selectedImageId); if(img){ img.style.opacity=e.target.value/100; imagesRef.child(selectedImageId).update({opacity:e.target.value/100}); saveStateToHistory(); }}});
            document.getElementById('brightness-slider').addEventListener('input', e => { if(selectedImageId){ const img=document.getElementById(selectedImageId); if(img){ img.style.filter=`brightness(${e.target.value}%)`; imagesRef.child(selectedImageId).update({brightness:e.target.value}); saveStateToHistory(); }}});

            document.getElementById('hide-btn').addEventListener('click', () => { if(selectedImageId){ const img=document.getElementById(selectedImageId); if(!img) return; const hidden=img.style.display==='none'; img.style.display=hidden?'block':'none'; imagesRef.child(selectedImageId).update({display:hidden?'block':'none'}); saveStateToHistory(); }});
            document.getElementById('delete-btn').addEventListener('click', () => { if(selectedImageId && confirm('Удалить изображение?')){ imagesRef.child(selectedImageId).remove(); deselectAllElements(); saveStateToHistory(); }});
            document.getElementById('settings-btn').addEventListener('click', () => { if(selectedImageId){ const panel=document.getElementById('properties-panel'); const img=document.getElementById(selectedImageId); document.getElementById('opacity-slider').value=(parseFloat(img.style.opacity)||0.3)*100; document.getElementById('brightness-slider').value=img.style.filter.includes('brightness')?parseInt(img.style.filter.match(/brightness\((\d+)%\)/)[1]):85; panel.style.display='block'; }});
            document.getElementById('lock-btn').addEventListener('click', () => { if(selectedImageId){ const img=document.getElementById(selectedImageId); if(!img) return; const locked=img.classList.contains('locked'); img.classList.toggle('locked'); document.getElementById('lock-btn').textContent=locked?'Закрепить':'Открепить'; imagesRef.child(selectedImageId).update({locked:!locked}); saveStateToHistory(); }});

            imagesRef.on('value', s => { images = s.val()||{}; updateCanvas(images); updateThumbnails(); });
            textsRef.on('value', s => { texts = s.val()||{}; updateTexts(texts); updateThumbnails(); });
            soundsRef.on('value', s => { sounds = s.val()||{}; updateThumbnails(); if(selectedSoundId && !sounds[selectedSoundId]){ selectedSoundId=null; document.getElementById('sound-controls').style.display='none'; } if(selectedSoundId && sounds[selectedSoundId]) updateSoundControls(sounds[selectedSoundId]); });

            document.addEventListener('mousemove', handleMove);
            document.addEventListener('touchmove', handleMove, {passive:false});
            document.addEventListener('mouseup', endInteraction);
            document.addEventListener('touchend', endInteraction);
            document.addEventListener('keydown', e => { if(e.ctrlKey && e.key==='z'){ e.preventDefault(); undoAction(); }});

            const audio = document.getElementById('audio-element');
            audio.addEventListener('timeupdate', updateSoundProgress);
            audio.addEventListener('ended', soundEnded);
        }

        // TTS
        function initTTS(){
            if('speechSynthesis' in window){
                speechSynthesis.onvoiceschanged = () => { voices = speechSynthesis.getVoices(); populateVoiceList(); isTTSInitialized=true; };
                voices = speechSynthesis.getVoices(); if(voices.length) { populateVoiceList(); isTTSInitialized=true; }
            } else { console.warn('TTS не поддерживается'); }
        }
        function populateVoiceList(){
            const sel = document.getElementById('tts-voice-select'); sel.innerHTML='<option value="">Выберите голос...</option>';
            const ru = voices.filter(v=>v.lang.startsWith('ru')||v.name.toLowerCase().includes('russian'));
            (ru.length?ru:voices).forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; sel.appendChild(o); });
            if(ru.length) sel.value=ru[0].name;
        }
        function showTTSPanel(){ const p=document.getElementById('tts-panel'); p.style.display='block'; document.getElementById('tts-text-input').value=''; ['tts-rate','tts-pitch','tts-volume'].forEach(id=>document.getElementById(id+'-slider').value=1); ['tts-rate','tts-pitch','tts-volume'].forEach(id=>document.getElementById(id+'-value').textContent='1.0'); stopTTS(); }
        function closeTTSPanel(){ document.getElementById('tts-panel').style.display='none'; stopTTS(); }
        function playTTS(){
            const txt=document.getElementById('tts-text-input').value.trim(); if(!txt){ alert('Введите текст'); return; }
            if(speechSynthesis.speaking) speechSynthesis.cancel();
            speechUtterance = new SpeechSynthesisUtterance(txt);
            const v=voices.find(v=>v.name===document.getElementById('tts-voice-select').value); if(v) speechUtterance.voice=v;
            speechUtterance.rate=parseFloat(document.getElementById('tts-rate-slider').value);
            speechUtterance.pitch=parseFloat(document.getElementById('tts-pitch-slider').value);
            speechUtterance.volume=parseFloat(document.getElementById('tts-volume-slider').value);
            speechUtterance.onstart=()=>{ document.getElementById('tts-play-btn').disabled=true; document.getElementById('tts-pause-btn').disabled=false; document.getElementById('tts-stop-btn').disabled=false; };
            speechUtterance.onend=()=>{ document.getElementById('tts-play-btn').disabled=false; document.getElementById('tts-pause-btn').disabled=true; document.getElementById('tts-stop-btn').disabled=true; };
            speechSynthesis.speak(speechUtterance);
        }
        function pauseTTS(){ if(speechSynthesis.speaking) speechSynthesis.pause(); document.getElementById('tts-play-btn').disabled=false; document.getElementById('tts-pause-btn').disabled=true; }
        function stopTTS(){ speechSynthesis.cancel(); document.getElementById('tts-play-btn').disabled=false; document.getElementById('tts-pause-btn').disabled=true; document.getElementById('tts-stop-btn').disabled=true; }
        function updateTTSVoice(){ if(speechUtterance && speechSynthesis.speaking){ const v=voices.find(v=>v.name===this.value); if(v){ speechUtterance.voice=v; speechSynthesis.cancel(); setTimeout(playTTS,100); }}}
        function updateTTSRate(){ if(speechUtterance) speechUtterance.rate=parseFloat(this.value); }
        function updateTTSPitch(){ if(speechUtterance) speechUtterance.pitch=parseFloat(this.value); }
        function updateTTSVolume(){ if(speechUtterance) speechUtterance.volume=parseFloat(this.value); }

        // Thumbnails
        function updateThumbnails(){
            const cont=document.getElementById('thumbnails'); cont.innerHTML='';
            for(const id in images) cont.appendChild(createImageThumbnailElement(images[id]));
            for(const id in texts) cont.appendChild(createTextThumbnailElement(texts[id]));
            for(const id in sounds) cont.appendChild(createSoundThumbnailElement(sounds[id],id));
        }
        function createImageThumbnailElement(d){
            const t=document.createElement('div'); t.id='thumb_'+d.id; t.className='thumbnail';
            if(d.display==='none') t.classList.add('thumbnail-hidden');
            if(selectedImageId===d.id) t.classList.add('selected');
            const i=document.createElement('img'); i.src=d.src; t.appendChild(i);
            const b=document.createElement('button'); b.className='thumbnail-button'; b.textContent=d.display==='none'?'Show':'Hide'; b.title=d.display==='none'?'Показать':'Скрыть';
            if(d.display==='none') b.classList.add('show');
            b.addEventListener('click',e=>{e.stopPropagation(); toggleImageVisibility(d.id,d.display==='none');});
            t.appendChild(b);
            t.addEventListener('click',()=>{selectImageFromThumbnail(d.id);});
            return t;
        }
        function createTextThumbnailElement(d){
            const t=document.createElement('div'); t.id='thumb_'+d.id; t.className='thumbnail';
            if(d.display==='none') t.classList.add('thumbnail-hidden');
            if(selectedTextId===d.id) t.classList.add('selected');
            const p=document.createElement('div'); p.className='text-thumbnail'; p.textContent=d.text.length>10?d.text.substring(0,10)+'...':d.text;
            p.style.fontSize='10px'; p.style.color=d.color; p.style.fontFamily=d.fontFamily||'Arial, sans-serif'; t.appendChild(p);
            const b=document.createElement('button'); b.className='thumbnail-button'; b.textContent=d.display==='none'?'Show':'Hide'; b.title=d.display==='none'?'Показать':'Скрыть';
            if(d.display==='none') b.classList.add('show');
            b.addEventListener('click',e=>{e.stopPropagation(); toggleTextVisibility(d.id,d.display==='none');});
            t.appendChild(b);
            t.addEventListener('click',()=>{selectTextFromThumbnail(d.id);});
            return t;
        }
        function createSoundThumbnailElement(d,id){
            const t=document.createElement('div'); t.id='thumb_'+id; t.className='thumbnail';
            if(d.display==='none') t.classList.add('thumbnail-hidden');
            if(selectedSoundId===id) t.classList.add('selected');
            const p=document.createElement('div'); p.className='sound-thumbnail'; const n=d.name||'sound'; p.textContent=n.length>10?n.substring(0,10)+'...':n; p.title=n; t.appendChild(p);
            const b=document.createElement('button'); b.className='thumbnail-button'; b.textContent=d.display==='none'?'Show':'Hide'; b.title=d.display==='none'?'Показать':'Скрыть';
            if(d.display==='none') b.classList.add('show');
            b.addEventListener('click',e=>{e.stopPropagation(); toggleSoundVisibility(id,d.display==='none');});
            t.appendChild(b);
            t.addEventListener('click',()=>{selectSoundFromThumbnail(id);});
            return t;
        }
        function toggleImageVisibility(id,show){
            const disp=show?'block':'none'; const el=document.getElementById(id); if(el) el.style.display=disp;
            imagesRef.child(id).update({display:disp});
            const thumb=document.getElementById('thumb_'+id); if(thumb){ const btn=thumb.querySelector('.thumbnail-button'); btn.textContent=show?'Hide':'Show'; btn.title=show?'Скрыть':'Показать'; btn.classList.toggle('show',!show); thumb.classList.toggle('thumbnail-hidden',!show); }
            saveStateToHistory();
        }
        function toggleTextVisibility(id,show){
            const disp=show?'block':'none'; const el=document.getElementById(id); if(el) el.style.display=disp;
            textsRef.child(id).update({display:disp});
            const thumb=document.getElementById('thumb_'+id); if(thumb){ const btn=thumb.querySelector('.thumbnail-button'); btn.textContent=show?'Hide':'Show'; btn.title=show?'Скрыть':'Показать'; btn.classList.toggle('show',!show); thumb.classList.toggle('thumbnail-hidden',!show); }
            saveStateToHistory();
        }
        function toggleSoundVisibility(id,show){
            if(!sounds[id]) return; const disp=show?'block':'none';
            soundsRef.child(id).update({display:disp});
            const thumb=document.getElementById('thumb_'+id); if(thumb){ const btn=thumb.querySelector('.thumbnail-button'); btn.textContent=show?'Hide':'Show'; btn.title=show?'Скрыть':'Показать'; btn.classList.toggle('show',!show); thumb.classList.toggle('thumbnail-hidden',!show); }
            saveStateToHistory();
        }
        function selectImageFromThumbnail(id){
            const el=document.getElementById(id); if(el && el.style.display!=='none'){ deselectAllElements(); el.classList.add('selected'); selectedImageId=id; document.getElementById('image-controls').style.display='flex'; document.getElementById('lock-btn').textContent=el.classList.contains('locked')?'Открепить':'Закрепить'; const thumb=document.getElementById('thumb_'+id); if(thumb) thumb.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}); }}
        function selectTextFromThumbnail(id){
            const el=document.getElementById(id); if(el && el.style.display!=='none'){ deselectAllElements(); el.classList.add('selected'); selectedTextId=id; document.getElementById('text-controls').style.display='flex'; document.getElementById('lock-text-btn').textContent=el.classList.contains('locked')?'Открепить':'Закрепить'; const thumb=document.getElementById('thumb_'+id); if(thumb) thumb.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}); }}
        function selectSoundFromThumbnail(id){
            if(sounds[id] && (!sounds[id].display || sounds[id].display!=='none')){ deselectAllElements(); selectedSoundId=id; document.getElementById('sound-controls').style.display='flex'; updateSoundControls(sounds[id]); const thumb=document.getElementById('thumb_'+id); if(thumb){ thumb.classList.add('selected'); thumb.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'}); }}}
        function deselectAllElements(){
            document.querySelectorAll('.draggable-image,.draggable-text').forEach(e=>e.classList.remove('selected'));
            ['image-controls','text-controls','sound-controls'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('properties-panel').style.display='none';
            document.querySelectorAll('.thumbnail').forEach(t=>t.classList.remove('selected'));
            selectedImageId=selectedTextId=selectedSoundId=null;
        }

        // History
        function saveStateToHistory(){
            if(actionHistory.length>=20) actionHistory.shift();
            Promise.all([imagesRef.once('value').then(s=>s.val()||{}), textsRef.once('value').then(s=>s.val()||{}), soundsRef.once('value').then(s=>s.val()||{})])
                .then(([i,t,s])=>{ actionHistory.push(JSON.stringify({images:i,texts:t,sounds:s})); historyPointer=actionHistory.length-1; });
        }
        function undoAction(){
            if(historyPointer<=0) return; historyPointer--;
            const st=JSON.parse(actionHistory[historyPointer]);
            imagesRef.set(st.images||{}); textsRef.set(st.texts||{}); soundsRef.set(st.sounds||{});
        }

        // Upload
        function handleFileUpload(e){
            const f=e.target.files[0]; if(!f) return;
            const r=new FileReader(); r.onload=ev=>{
                const img=new Image(); img.onload=()=>{
                    const id='img_'+Date.now(); const x=100, y=100;
                    imagesRef.child(id).set({id,x,y,width:img.width,height:img.height,src:ev.target.result,opacity:0.3,brightness:85,isNew:true,locked:false,display:'block'});
                    saveStateToHistory();
                }; img.src=ev.target.result;
            }; r.readAsDataURL(f); e.target.value='';
        }
        function handleSoundUpload(e){
            const f=e.target.files[0]; if(!f) return;
            const r=new FileReader(); r.onload=ev=>{
                const id='sound_'+Date.now();
                soundsRef.child(id).set({id,src:ev.target.result,name:f.name,playing:false,currentTime:0,duration:0,volume:100,display:'block'});
                saveStateToHistory();
            }; r.readAsDataURL(f); e.target.value='';
        }

        // Sound
        function updateSoundControls(d){
            const ctrl=document.getElementById('sound-controls'); const audio=document.getElementById('audio-element');
            if(d && d.src){ ctrl.style.display='flex'; if(audio.src!==d.src){ audio.src=d.src; audio.onloadedmetadata=()=>{ soundsRef.child(selectedSoundId).update({duration:audio.duration}); }; }}
            if(d.volume!==undefined){ audio.volume=d.volume/100; document.getElementById('volume-slider').value=d.volume; } else { audio.volume=1; document.getElementById('volume-slider').value=100; }
            if(d.playing && audio.paused){ audio.currentTime=d.currentTime||0; audio.play().catch(()=>{}); } else if(!d.playing && !audio.paused) audio.pause();
            updateProgressVisualization(d.currentTime, d.duration);
        }
        function playSound(){
            if(!selectedSoundId || !sounds[selectedSoundId]) return;
            const audio=document.getElementById('audio-element'); audio.play().then(()=>{ soundsRef.child(selectedSoundId).update({playing:true,currentTime:audio.currentTime}); if(soundInterval) clearInterval(soundInterval); soundInterval=setInterval(()=>{ if(!audio.paused) soundsRef.child(selectedSoundId).update({currentTime:audio.currentTime}); },1000); }).catch(()=>{});
        }
        function pauseSound(){
            if(!selectedSoundId || !sounds[selectedSoundId]) return;
            const audio=document.getElementById('audio-element'); audio.pause(); soundsRef.child(selectedSoundId).update({playing:false,currentTime:audio.currentTime}); if(soundInterval){ clearInterval(soundInterval); soundInterval=null; }
        }
        function updateVolume(e){
            if(!selectedSoundId || !sounds[selectedSoundId]) return;
            const v=e.target.value; const audio=document.getElementById('audio-element'); audio.volume=v/100; soundsRef.child(selectedSoundId).update({volume:v}); saveStateToHistory();
        }
        function deleteSound(){
            if(selectedSoundId && confirm('Удалить звук?')){ soundsRef.child(selectedSoundId).remove(); document.getElementById('audio-element').src=''; document.getElementById('audio-element').pause(); if(soundInterval){ clearInterval(soundInterval); soundInterval=null; } deselectAllElements(); saveStateToHistory(); }
        }
        function updateSoundProgress(){
            if(!selectedSoundId || !sounds[selectedSoundId] || !sounds[selectedSoundId].playing) return;
            const audio=document.getElementById('audio-element'); updateProgressVisualization(audio.currentTime, audio.duration);
        }
        function updateProgressVisualization(cur,dur){
            const p=document.getElementById('sound-progress'); if(dur>0) p.style.width=(cur/dur*100)+'%'; else p.style.width='0%';
        }
        function soundEnded(){
            if(soundInterval){ clearInterval(soundInterval); soundInterval=null; }
            if(selectedSoundId) soundsRef.child(selectedSoundId).update({playing:false,currentTime:0});
        }

        // Text
        function showTextInputPanel(){
            deselectAllElements(); const p=document.getElementById('text-input-panel'); document.getElementById('text-input').value=''; document.getElementById('font-size-input').value=16; document.getElementById('text-color-input').value='#000000'; document.getElementById('font-family-select').value="'Comic Sans MS', cursive"; document.getElementById('text-panel-title').textContent='Добавить текст'; p.style.display='block'; isEditingText=false; currentTextId=null;
        }
        function applyTextChanges(){
            const txt=document.getElementById('text-input').value.trim(); if(!txt) return;
            const fs=parseInt(document.getElementById('font-size-input').value); const col=document.getElementById('text-color-input').value; const ff=document.getElementById('font-family-select').value;
            if(isEditingText && currentTextId){ textsRef.child(currentTextId).update({text:txt,fontSize:fs,color:col,fontFamily:ff}); } else { const id='text_'+Date.now(); const x=100, y=100; textsRef.child(id).set({id,text:txt,x,y,fontSize:fs,color:col,fontFamily:ff,opacity:0.3,isNew:true,locked:false,display:'block'}); }
            document.getElementById('text-input-panel').style.display='none'; saveStateToHistory(); isEditingText=false; currentTextId=null;
        }
        function cancelTextEdit(){ document.getElementById('text-input-panel').style.display='none'; isEditingText=false; currentTextId=null; }
        function editSelectedText(){
            if(!selectedTextId) return; const el=document.getElementById(selectedTextId); if(!el) return;
            const p=document.getElementById('text-input-panel'); document.getElementById('text-input').value=el.textContent; document.getElementById('font-size-input').value=parseInt(el.style.fontSize); document.getElementById('text-color-input').value=el.style.color; document.getElementById('font-family-select').value=el.style.fontFamily; document.getElementById('text-panel-title').textContent='Редактировать текст'; p.style.display='block'; isEditingText=true; currentTextId=selectedTextId;
        }
        function deleteSelectedText(){ if(selectedTextId && confirm('Удалить текст?')){ textsRef.child(selectedTextId).remove(); deselectAllElements(); saveStateToHistory(); }}
        function toggleTextLock(){
            if(selectedTextId){ const el=document.getElementById(selectedTextId); if(!el) return; const locked=el.classList.contains('locked'); el.classList.toggle('locked'); document.getElementById('lock-text-btn').textContent=locked?'Закрепить':'Открепить'; textsRef.child(selectedTextId).update({locked:!locked}); saveStateToHistory(); }
        }

        // Canvas update
        function updateCanvas(data){
            const cont=document.getElementById('elements-layer');
            document.querySelectorAll('.draggable-image').forEach(el=>{ if(!data[el.id]){ el.remove(); if(selectedImageId===el.id) deselectAllElements(); }});
            for(const id in data){
                const d=data[id]; let el=document.getElementById(id);
                if(!el){ el=createImageElement(d); cont.appendChild(el); }
                updateImagePositionAndSize(el,d); updateImageOpacity(el,d); updateImageBrightness(el,d); updateImageLockState(el,d); updateImageDisplayState(el,d);
                if(d.isNew){ deselectAllElements(); el.classList.add('selected'); selectedImageId=id; document.getElementById('image-controls').style.display='flex'; document.getElementById('lock-btn').textContent=d.locked?'Открепить':'Закрепить'; imagesRef.child(id).update({isNew:null}); }
            }
        }
        function updateTexts(data){
            const cont=document.getElementById('elements-layer');
            document.querySelectorAll('.draggable-text').forEach(el=>{ if(!data[el.id]){ el.remove(); if(selectedTextId===el.id) deselectAllElements(); }});
            for(const id in data){
                const d=data[id]; let el=document.getElementById(id);
                if(!el){ el=createTextElement(d); cont.appendChild(el); } else { updateTextPosition(el,d); updateTextContent(el,d); updateTextLockState(el,d); updateTextDisplayState(el,d); }
                if(d.opacity!==undefined) el.style.opacity=d.opacity;
                if(d.fontFamily) el.style.fontFamily=d.fontFamily;
                if(d.isNew){ deselectAllElements(); el.classList.add('selected'); selectedTextId=id; document.getElementById('text-controls').style.display='flex'; document.getElementById('lock-text-btn').textContent=d.locked?'Открепить':'Закрепить'; textsRef.child(id).update({isNew:null}); }
            }
        }

        // Elements creation
        function createImageElement(d){
            const w=document.createElement('div'); w.id=d.id; w.className='draggable-image';
            w.style.left=d.x+'px'; w.style.top=d.y+'px'; w.style.width=d.width+'px'; w.style.height=d.height+'px';
            w.style.opacity=d.opacity!==undefined?d.opacity:0.3; w.style.filter=`brightness(${d.brightness!==undefined?d.brightness:85}%)`;
            if(d.locked) w.classList.add('locked'); w.style.display=d.display==='none'?'none':'block';
            const i=document.createElement('img'); i.src=d.src; i.style.width='100%'; i.style.height='100%'; i.style.objectFit='contain'; i.draggable=false; w.appendChild(i);
            addResizeHandles(w);
            w.addEventListener('mousedown', e=>{ if(e.target.classList.contains('resize-handle')) return; startSelect(e); });
            w.addEventListener('touchstart', e=>{ if(e.target.classList.contains('resize-handle')) return; startSelect(e); }, {passive:false});
            return w;
        }
        function createTextElement(d){
            const el=document.createElement('div'); el.id=d.id; el.className='draggable-text';
            el.style.left=d.x+'px'; el.style.top=d.y+'px'; el.textContent=d.text;
            el.style.fontSize=d.fontSize+'px'; el.style.color=d.color;
            el.style.fontFamily=d.fontFamily||"'Comic Sans MS', cursive";
            el.style.opacity=d.opacity!==undefined?d.opacity:0.3;
            if(d.locked) el.classList.add('locked'); el.style.display=d.display==='none'?'none':'block';
            el.style.width='auto'; el.style.height='auto';
            addResizeHandles(el);
            el.addEventListener('mousedown', e=>{ if(e.target.classList.contains('resize-handle')) return; startTextSelect(e); });
            el.addEventListener('touchstart', e=>{ if(e.target.classList.contains('resize-handle')) return; startTextSelect(e); }, {passive:false});
            return el;
        }
        function addResizeHandles(el){
            el.querySelectorAll('.resize-handle').forEach(h=>h.remove());
            ['n','ne','e','se','s','sw','w','nw'].forEach(dir=>{
                const h=document.createElement('div'); h.className=`resize-handle resize-${dir}`; el.appendChild(h);
                h.addEventListener('mousedown', e=>{ e.preventDefault(); e.stopPropagation(); startResize(e,dir); });
                h.addEventListener('touchstart', e=>{ e.preventDefault(); e.stopPropagation(); startResize(e,dir); }, {passive:false});
            });
        }

        // Interaction
        function startSelect(e){
            e.preventDefault(); e.stopPropagation(); const el=e.currentTarget; const locked=el.classList.contains('locked');
            deselectAllElements(); el.classList.add('selected'); selectedImageId=el.id; document.getElementById('image-controls').style.display='flex'; document.getElementById('lock-btn').textContent=locked?'Открепить':'Закрепить';
            if(!locked){ activeInteraction='select'; activeElement=el; const x=parseInt(el.style.left)||0, y=parseInt(el.style.top)||0; startX=(e.type==='touchstart'?e.touches[0].clientX:e.clientX)-x; startY=(e.type==='touchstart'?e.touches[0].clientY:e.clientY)-y; }
        }
        function startTextSelect(e){
            e.preventDefault(); e.stopPropagation(); const el=e.currentTarget; const locked=el.classList.contains('locked');
            deselectAllElements(); el.classList.add('selected'); selectedTextId=el.id; document.getElementById('text-controls').style.display='flex'; document.getElementById('lock-text-btn').textContent=locked?'Открепить':'Закрепить';
            if(!locked){ activeInteraction='select'; activeElement=el; const x=parseInt(el.style.left)||0, y=parseInt(el.style.top)||0; startX=(e.type==='touchstart'?e.touches[0].clientX:e.clientX)-x; startY=(e.type==='touchstart'?e.touches[0].clientY:e.clientY)-y; }
        }
        function startResize(e,dir){
            if(e.currentTarget.parentElement.classList.contains('locked')) return;
            e.preventDefault(); e.stopPropagation(); activeInteraction='resize'; activeElement=e.currentTarget.parentElement; resizeDirection=dir;
            const r=activeElement.getBoundingClientRect(); startX=e.type==='touchstart'?e.touches[0].clientX:e.clientX; startY=e.type==='touchstart'?e.touches[0].clientY:e.clientY;
            startWidth=parseFloat(activeElement.style.width)||activeElement.offsetWidth; startHeight=parseFloat(activeElement.style.height)||activeElement.offsetHeight;
            startLeft=parseFloat(activeElement.style.left)||0; startTop=parseFloat(activeElement.style.top)||0;
        }
        function handleMove(e){
            if(!activeInteraction || !activeElement || activeElement.classList.contains('locked')) return; e.preventDefault();
            const cx=e.type==='touchmove'?e.touches[0].clientX:e.clientX, cy=e.type==='touchmove'?e.touches[0].clientY:e.clientY;
            if(activeInteraction==='select' || activeInteraction==='drag'){
                const x=cx-startX, y=cy-startY; const cont=document.getElementById('canvas-wrapper');
                const maxX=cont.offsetWidth-activeElement.offsetWidth, maxY=cont.offsetHeight-activeElement.offsetHeight;
                const bx=Math.max(0,Math.min(x,maxX)), by=Math.max(0,Math.min(y,maxY));
                activeElement.style.left=bx+'px'; activeElement.style.top=by+'px';
                if(activeElement.classList.contains('draggable-image')) imagesRef.child(activeElement.id).update({x:bx,y:by});
                else if(activeElement.classList.contains('draggable-text')) textsRef.child(activeElement.id).update({x:bx,y:by});
                if(activeInteraction==='select') activeInteraction='drag';
            } else if(activeInteraction==='resize'){
                const dx=cx-startX, dy=cy-startY; let w=startWidth, h=startHeight, l=startLeft, t=startTop;
                switch(resizeDirection){
                    case 'n': h=Math.max(50,startHeight-dy); t=startTop+(startHeight-h); break;
                    case 'ne': h=Math.max(50,startHeight-dy); t=startTop+(startHeight-h); w=Math.max(50,startWidth+dx); break;
                    case 'e': w=Math.max(50,startWidth+dx); break;
                    case 'se': w=Math.max(50,startWidth+dx); h=Math.max(50,startHeight+dy); break;
                    case 's': h=Math.max(50,startHeight+dy); break;
                    case 'sw': w=Math.max(50,startWidth-dx); l=startLeft+(startWidth-w); h=Math.max(50,startHeight+dy); break;
                    case 'w': w=Math.max(50,startWidth-dx); l=startLeft+(startWidth-w); break;
                    case 'nw': w=Math.max(50,startWidth-dx); l=startLeft+(startWidth-w); h=Math.max(50,startHeight-dy); t=startTop+(startHeight-h); break;
                }
                activeElement.style.width=w+'px'; activeElement.style.height=h+'px'; activeElement.style.left=l+'px'; activeElement.style.top=t+'px';
                if(activeElement.classList.contains('draggable-image')) imagesRef.child(activeElement.id).update({width:w,height:h,x:l,y:t});
                else if(activeElement.classList.contains('draggable-text')){
                    const fs=parseInt(activeElement.style.fontSize)||16; const scale=w/startWidth; const nfs=Math.max(10,Math.min(72,Math.round(fs*scale)));
                    activeElement.style.fontSize=nfs+'px'; textsRef.child(activeElement.id).update({fontSize:nfs,x:l,y:t});
                }
            }
        }
        function endInteraction(){ if(activeInteraction) saveStateToHistory(); activeInteraction=null; activeElement=null; resizeDirection=null; }

        // Update helpers
        function updateImagePositionAndSize(el,d){ if(activeElement!==el){ el.style.left=d.x+'px'; el.style.top=d.y+'px'; el.style.width=d.width+'px'; el.style.height=d.height+'px'; }}
        function updateTextPosition(el,d){ if(activeElement!==el){ el.style.left=d.x+'px'; el.style.top=d.y+'px'; }}
        function updateTextContent(el,d){ el.textContent=d.text; el.style.fontSize=d.fontSize+'px'; el.style.color=d.color; if(d.fontFamily) el.style.fontFamily=d.fontFamily; }
        function updateImageOpacity(el,d){ el.style.opacity=d.opacity!==undefined?d.opacity:0.3; }
        function updateImageBrightness(el,d){ el.style.filter=`brightness(${d.brightness!==undefined?d.brightness:85}%)`; }
        function updateImageLockState(el,d){ if(d.locked){ el.classList.add('locked'); el.style.cursor='default'; } else { el.classList.remove('locked'); el.style.cursor='move'; }}
        function updateImageDisplayState(el,d){ el.style.display=d.display==='none'?'none':'block'; }
        function updateTextLockState(el,d){ if(d.locked){ el.classList.add('locked'); el.style.cursor='default'; } else { el.classList.remove('locked'); el.style.cursor='move'; }}
        function updateTextDisplayState(el,d){ el.style.display=d.display==='none'?'none':'block'; }

        function clearCanvas(){ if(confirm('Очистить холст для всех?')){ imagesRef.remove(); textsRef.remove(); soundsRef.remove(); deselectAllElements(); saveStateToHistory(); }}

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
